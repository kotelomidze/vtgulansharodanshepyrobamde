
<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ვეფხისტყაოსნის ტესტი: 1070-1221</title>
    
    <!-- ბიბლიოთეკები -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- ფონტები -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans Georgian', sans-serif;
            background-color: #fcf9f2;
        }
        .georgian-classic {
            font-family: 'Playfair Display', serif;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a29e; }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-stone-50 text-stone-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- მონაცემები (Exercises) ---
        const EXERCISES = [
            {
                id: '1',
                type: 'MULTIPLE_CHOICE',
                difficulty: 'მარტივი',
                stanza: '1070: "ზღვა გაიარა ავთანდილ, მივა ტანითა მჭევრითა. ნახეს ქალაქი, მოცული გარე ბაღისა ტევრითა..."',
                question: 'რა ქალაქის აღწერაა მოცემული ამ სტროფში?',
                options: ['ხატაეთი', 'ინდოეთი', 'გულანშარო', 'არაბეთი'],
                correctAnswer: 'გულანშარო',
                explanation: 'ავთანდილი ზღვით მიდის და მიადგება გულანშაროს, რომელიც ბაღებითაა მოცული.'
            },
            {
                id: '2',
                type: 'TRUE_FALSE',
                difficulty: 'მარტივი',
                stanza: '1071: "ავთანდილ ტანსა ჯუბანი ჩაიცვნა, დაჯდა სკამითა; იგი ყმა ვაჭრობს, თავადობს და თავსა მალავს ამითა."',
                question: 'ავთანდილი გულანშაროში საკუთარ ვინაობას მალავს და თავს ვაჭრად ასაღებს.',
                correctAnswer: true,
                explanation: 'ავთანდილი მიზანმიმართულად იცვამს ვაჭრულად, რათა შეუმჩნევლად მოიპოვოს ინფორმაცია.'
            },
            {
                id: '3',
                type: 'GAP_FILL',
                difficulty: 'საშუალო',
                stanza: '1103: "კოკასა შიგან რაცა დგას, იგივე _______!"',
                question: 'შეავსეთ გამოტოვებული სიტყვა სტროფიდან:',
                options: ['გამჟღავნდების', 'წარმოსდინდების', 'გამოითქმის', 'ამოიფრქვევის'],
                correctAnswer: 'წარმოსდინდების',
                explanation: 'ეს არის ერთ-ერთი ყველაზე ცნობილი აფორიზმი, რაც ნიშნავს, რომ ადამიანისგან ის გამოდის, რაც მასშია.'
            },
            {
                id: '4',
                type: 'MATCHING',
                difficulty: 'საშუალო',
                question: 'დაუკავშირეთ პერსონაჟი მის დახასიათებას:',
                matchingPairs: [
                    { left: 'ფატმანი', right: 'ვაჭართა უხუცესის ცოლი' },
                    { left: 'უსენი', right: 'ვაჭართა უხუცესი' },
                    { left: 'ავთანდილი', right: 'ვაჭრად გარდაქმნილი რაინდი' },
                    { left: 'მელიქ-სურხავი', right: 'გულანშაროს ხელმწიფე' }
                ],
                correctAnswer: true,
                explanation: 'ფატმანი უსენის ცოლია, უსენი - ვაჭართუხუცესი, ავთანდილი - სტუმარი, მელიქ-სურხავი - მეფე.'
            },
            {
                id: '5',
                type: 'ORDERING',
                difficulty: 'რთული',
                question: 'დაალაგეთ მოვლენები ქრონოლოგიური თანამიმდევრობით:',
                orderingItems: [
                    "ავთანდილის მიერ ჭაშნაგირის მოკვლა",
                    "ფატმანისგან წერილის მიღება",
                    "ფატმანის მიერ ნესტანის პოვნის ამბის მოყოლა",
                    "ავთანდილის შესვლა გულანშაროში"
                ],
                correctAnswer: [3, 1, 0, 2],
                explanation: 'ჯერ შედის ქალაქში, მერე ფატმანი წერილს სწერს, მერე ავთანდილი კლავს ჭაშნაგირს და ბოლოს ფატმანი უყვება ნესტანის ამბავს.'
            },
            {
                id: '6',
                type: 'MULTIPLE_CHOICE',
                difficulty: 'საშუალო',
                stanza: '1090: "სჯობს სიშორე დიაცისა, ვისგან ვითა დაითმობის..."',
                question: 'რა არის ამ სტროფის ძირითადი იდეა?',
                options: [
                    'ქალის ერთგულების ქება',
                    'გაფრთხილება ქალის მერყევი ბუნების შესახებ',
                    'მეგობრობის მნიშვნელობა',
                    'ვაჭრობის წესები'
                ],
                correctAnswer: 'გაფრთხილება ქალის მერყევი ბუნების შესახებ',
                explanation: 'ამ სტროფში ავტორი საუბრობს ქალისგან შესაძლო ღალატსა და საიდუმლოს გაცემაზე.'
            },
            {
                id: '7',
                type: 'CATEGORIZATION',
                difficulty: 'რთული',
                question: 'დააჯგუფეთ ციტატები თემატიკის მიხედვით:',
                categories: [
                    { name: 'სიყვარული', items: ['"შენ გტრფიალობენ მჭვრეტელნი"', '"შენი შვენება ყვავილთა აჭნობს"'] },
                    { name: 'აღწერა', items: ['"ზღვა გაიარა ავთანდილ"', '"ქვითა წითელ-მწვანითა"'] }
                ],
                correctAnswer: true,
                explanation: 'პირველი ჯგუფი ეხება გრძნობებს, მეორე - გარემოსა და ქმედებას.'
            },
            {
                id: '8',
                type: 'TRUE_FALSE',
                difficulty: 'მარტივი',
                stanza: '1125: "ბეჭდითურთ თითი მოჰკვეთა, ქვესკნელს მიწათა გარია..."',
                question: 'ავთანდილმა მოკლული ჩაშნაგირის ბეჭდიანი თითი სამხილად შეინახა.',
                correctAnswer: true,
                explanation: 'დიახ, ავთანდილმა თითი მოჰკვეთა და ფატმანს მიუტანა მტკიცებულებად.'
            },
            {
                id: '9',
                type: 'MULTIPLE_CHOICE',
                difficulty: 'საშუალო',
                stanza: '1206: "ვა ოქრო მისთა მოყვასთა აროდეს მისცემს ლხენასა..."',
                question: 'რას ამბობს ავტორი სიხარბეზე და ოქროზე?',
                options: [
                    'ოქრო ბედნიერების მომტანია',
                    'ოქრო ადამიანს სულს უმძიმებს',
                    'ოქროთი ყველაფრის ყიდვა შეიძლება',
                    'ოქრო მხოლოდ მეფეებს სჭირდებათ'
                ],
                correctAnswer: 'ოქრო ადამიანს სულს უმძიმებს',
                explanation: 'სტროფში ნათქვამია, რომ სიხარბე კბილთა ღრჭენას იწვევს და სულს "აღმაფრენას" უშლის.'
            },
            {
                id: '10',
                type: 'GAP_FILL',
                difficulty: 'მარტივი',
                stanza: '1086: "_______ თვალად მარჯვე, არ-ყმაწვილი, მაგრა"',
                question: 'როგორ აგრძელებს ავტორი ფატმანის აღწერას?',
                options: ['ფატმან ხათუნ', 'მელიქ-სურხავ', 'ქაჯთა მეფე', 'ინდოთ მეფე'],
                correctAnswer: 'ფატმან ხათუნ',
                explanation: 'ეს არის ფატმანის აღწერილობა.'
            },
            {
                id: '11',
                type: 'MULTIPLE_CHOICE',
                difficulty: 'საშუალო',
                stanza: '1130: "ამა ქალაქსა წესია: დღესა მას ნავროზობასა..."',
                question: 'რა არის "ნავროზობა"?',
                options: ['აღლუმი', 'საგაზაფხულო დღესასწაული', 'გლოვის დღე', 'კრება'],
                correctAnswer: 'საგაზაფხულო დღესასწაული',
                explanation: 'ნავროზობა აღმოსავლური ახალი წელი და გაზაფხულის დღესასწაულია.'
            },
            {
                id: '12',
                type: 'TRUE_FALSE',
                difficulty: 'საშუალო',
                stanza: '1144: "მევუზახენ: „დახოცენით!“ დაიპყრნეს და თავსა სჭრიდეს..."',
                question: 'ფატმანმა ნესტანის გამოსახსნელად ზანგი ტყვეების დამჭერები დაახოცვინა.',
                correctAnswer: true,
                explanation: 'ფატმანმა დაინახა ნესტანი, მისი სილამაზით მოიხიბლა და მისი დაპატრონება გადაწყვიტა ძალის გამოყენებით.'
            },
            {
                id: '13',
                type: 'MATCHING',
                difficulty: 'რთული',
                question: 'დააკავშირეთ ციტატა პერსონაჟთან:',
                matchingPairs: [
                    { left: '"შენ ჩემთვის დედაო ხარ"', right: 'ნესტან-დარეჯანი' },
                    { left: '"დავხოცენ შვილნი ხელითა"', right: 'ფატმან ხათუნი' },
                    { left: '"არ გამამჟღავნოს, ვაფიცო"', right: 'უსენი' },
                    { left: '"რაცა ვუყო, მოგახსენებ"', right: 'ავთანდილი' }
                ],
                correctAnswer: true,
                explanation: 'ნესტანი ფატმანს მიმართავს, ფატმანი შვილების დახოცვით იმუქრება, უსენი ფიცს ტეხს, ავთანდილი ჩაშნაგირის მოკვლას ჰპირდება.'
            },
            {
                id: '14',
                type: 'MULTIPLE_CHOICE',
                difficulty: 'რთული',
                stanza: '1158: "სილბო ჰქონდა ნაქსოვისა და სიმტკიცე - ნაჭედისა."',
                question: 'რა ნივთს აღწერს ფატმანი ამ სიტყვებით?',
                options: ['აბჯარს', 'ნესტანის სამოსს', 'ხმალს', 'კარიბჭეს'],
                correctAnswer: 'ნესტანის სამოსს',
                explanation: 'ნესტანის უცხო სამოსი ერთდროულად ნაქსოვივით რბილი და რკინასავით მტკიცე იყო.'
            },
            {
                id: '15',
                type: 'TRUE_FALSE',
                difficulty: 'მარტივი',
                stanza: '1210: "ავხსენ ცხენი უკეთესი, შევუკაზმე, ზედა შევსვი..."',
                question: 'ფატმანმა ნესტანს გაქცევაში ხელი შეუშალა.',
                correctAnswer: false,
                explanation: 'პირიქით, ფატმანმა ნესტანი გააპარა და საუკეთესო ცხენიც მისცა.'
            },
            {
                id: '16',
                type: 'MULTIPLE_CHOICE',
                difficulty: 'საშუალო',
                stanza: '1175: "მართლად თქმულა: „არა ჰმართებს ყვავსა ვარდი, ვირსა რქანი“."',
                question: 'ვის მისამართით არის ნათქვამი ეს აფორიზმი?',
                options: ['ავთანდილის', 'უსენის', 'ჩაშნაგირის', 'მებაღის'],
                correctAnswer: 'უსენის',
                explanation: 'უსენმა ვერ შეინახა საიდუმლო და სიმთვრალეში გასცა ნესტანის ამბავი.'
            },
            {
                id: '17',
                type: 'GAP_FILL',
                difficulty: 'საშუალო',
                stanza: '1093: "დაწერა წიგნი საბრალო, მის ყმისა მისართმეველი, მისისა _________"',
                question: 'შეავსეთ გამოტოვებული სიტყვა:',
                options: ['სიძულვილისა', 'მიჯნურობისა', 'მეგობრობისა', 'სტუმრობისა'],
                correctAnswer: 'მიჯნურობისა',
                explanation: 'ფატმანმა ავთანდილს სიყვარულის გამჟღავნების წერილი მისწერა.'
            },
            {
                id: '18',
                type: 'MULTIPLE_CHOICE',
                difficulty: 'მარტივი',
                stanza: '1106: "ამას ღამე ნუ მოხვალო, ვერა მპოვებ შენთვის მზასა."',
                question: 'რატომ სთხოვა ფატმანმა ავთანდილს იმ ღამეს არ მისულიყო?',
                options: ['ავად გახდა', 'ქმარი დაუბრუნდა', 'ჭაშნაგირი უნდა მოსულიყო', 'გადიოდა'],
                correctAnswer: 'ჭაშნაგირი უნდა მოსულიყო',
                explanation: 'ფატმანს ჭაშნაგირი (საყვარელი) უნდა სწვეოდა და ავთანდილის მისვლა საშიში იყო.'
            },
            {
                id: '19',
                type: 'ORDERING',
                difficulty: 'საშუალო',
                question: 'დაალაგეთ პერსონაჟები გამოჩენის მიხედვით:',
                orderingItems: [
                    "მებაღე",
                    "ფატმან ხათუნი",
                    "ავთანდილი",
                    "ჩაშნაგირი"
                ],
                correctAnswer: [2, 0, 1, 3],
                explanation: 'ჯერ ავთანდილი მიდის, ხვდება მებაღეს, მერე ფატმანს და ბოლოს ჩნდება ჩაშნაგირი.'
            },
            {
                id: '20',
                type: 'MULTIPLE_CHOICE',
                difficulty: 'რთული',
                stanza: '1206: "კვლა აქა სულსა დააბამს, დაუშლის აღმაფრენასა."',
                question: 'რას ნიშნავს ფრაზა "დაუშლის აღმაფრენასა"?',
                options: ['ფრენას ასწავლის', 'ამაღლებას უშლის ხელს', 'დაჭერას გულისხმობს', 'სიმდიდრეს ნიშნავს'],
                correctAnswer: 'ამაღლებას უშლის ხელს',
                explanation: 'ამაღლებული სულისკვეთება და სიხარბე შეუთავსებელია.'
            },
            {
                id: '21',
                type: 'TRUE_FALSE',
                difficulty: 'საშუალო',
                stanza: '1110: "ვარ შენთა შვილთა შენითა კბილითა დამაჭმეველად..."',
                question: 'ჩაშნაგირი ფატმანს შვილების დახოცვით დაემუქრა.',
                correctAnswer: true,
                explanation: 'ჩაშნაგირმა დაინახა ავთანდილი ფატმანთან და შანტაჟი დაუწყო.'
            },
            {
                id: '22',
                type: 'MULTIPLE_CHOICE',
                difficulty: 'საშუალო',
                stanza: '1120: "_______ ჩემი აცვია, მას გვედრებ მოსატანელად."',
                question: 'რა ნივთის მოტანა სთხოვა ფატმანმა ავთანდილს?',
                options: ['ხმლის', 'ბეჭდის', 'მოსასხამის', 'თასის'],
                correctAnswer: 'ბეჭდის',
                explanation: 'ჭაშნაგირს ფატმანის ბეჭედი ეკეთა, რომელიც ავთანდილს უნდა დაებრუნებინა.'
            },
            {
                id: '23',
                type: 'GAP_FILL',
                difficulty: 'რთული',
                stanza: '1205: "ნახეთ, თუ ______ რასა იქმს, კვერთხი ეშმაკთა ძირისა!"',
                question: 'შეავსეთ გამოტოვებული სიტყვა:',
                options: ['ვერცხლი', 'რკინა', 'ოქრო', 'ალმასი'],
                correctAnswer: 'ოქრო',
                explanation: 'ოქროა ის "ეშმაკთა კვერთხი", რომელმაც ხადუმები მოქრთამა.'
            },
            {
                id: '24',
                type: 'MULTIPLE_CHOICE',
                difficulty: 'საშუალო',
                stanza: '1181: "დღეს რომელი უსენ შესძღვნა ქალი, მსგავსი მზეთა ორთა..."',
                question: 'რას ნიშნავს ფრაზა "შესძღვნა ქალი"?',
                options: ['საჩუქრად მიიყვანა', 'წიგნი აჩუქა', 'უმღერა', 'ცოლად მოიყვანა'],
                correctAnswer: 'საჩუქრად მიიყვანა',
                explanation: 'უსენმა მეფეს ნესტანის შესახებ უამბო, როგორც ძვირფასი "საჩუქრის" შესახებ.'
            },
            {
                id: '25',
                type: 'TRUE_FALSE',
                difficulty: 'რთული',
                stanza: '1220: "მოყვარე მტერი ყოვლისა მტრისაგანც უფრო მტერია"',
                question: 'ეს აფორიზმი ნიშნავს, რომ ორპირი მეგობარი ნებისმიერ აშკარა მტერზე საშიშია.',
                correctAnswer: true,
                explanation: 'დიახ, ავთანდილი ფატმანს ამით ამშვიდებს ჩაშნაგირის სიკვდილის შემდეგ.'
            }
        ];

        // --- Widgets ---

        const OrderingWidget = ({ items, onAnswer, disabled }) => {
            const [order, setOrder] = useState([]);
            const toggle = (i) => {
                if (disabled) return;
                const newOrder = order.includes(i) ? order.filter(x => x !== i) : [...order, i];
                setOrder(newOrder);
                if (newOrder.length === items.length) onAnswer(newOrder);
            };
            return (
                <div className="space-y-3">
                    {items.map((item, i) => {
                        const rank = order.indexOf(i) + 1;
                        return (
                            <button key={i} onClick={() => toggle(i)} disabled={disabled} 
                                    className={`w-full flex items-center p-4 border-2 rounded-xl transition-all text-left ${rank > 0 ? 'border-amber-500 bg-amber-50' : 'border-stone-200'} ${disabled ? 'opacity-50' : 'hover:bg-stone-50'}`}>
                                <span className={`w-8 h-8 rounded-full flex items-center justify-center mr-4 font-bold ${rank > 0 ? 'bg-amber-500 text-white' : 'bg-stone-100 text-stone-400'}`}>{rank || ''}</span>
                                <span className="flex-1">{item}</span>
                            </button>
                        );
                    })}
                </div>
            );
        };

        const MatchingWidget = ({ pairs, onAnswer, disabled }) => {
            const [left, setLeft] = useState(null);
            const [done, setDone] = useState([]);
            const [shuffledRight] = useState(() => [...pairs].sort(() => Math.random() - 0.5));

            const check = (r) => {
                if (!left || disabled) return;
                if (pairs.find(p => p.left === left)?.right === r) {
                    const nextDone = [...done, left];
                    setDone(nextDone); setLeft(null);
                    if (nextDone.length === pairs.length) onAnswer(true);
                } else setLeft(null);
            };

            return (
                <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">{pairs.map((p, i) => <button key={i} onClick={() => !done.includes(p.left) && setLeft(p.left)} className={`w-full p-4 border-2 rounded-xl text-left text-sm ${left === p.left ? 'border-amber-500 bg-amber-50' : done.includes(p.left) ? 'opacity-30 border-green-200 bg-green-50' : 'border-stone-200'}`}>{p.left}</button>)}</div>
                    <div className="space-y-2">{shuffledRight.map((p, i) => <button key={i} onClick={() => check(p.right)} className={`w-full p-4 border-2 rounded-xl text-left text-sm ${done.includes(pairs.find(x => x.right === p.right)?.left) ? 'opacity-30 border-green-200 bg-green-50' : 'border-stone-200'}`}>{p.right}</button>)}</div>
                </div>
            );
        };

        const CategorizationWidget = ({ categories, onAnswer, disabled }) => {
            const [active, setActive] = useState(null);
            const allItems = useMemo(() => categories.flatMap(c => c.items).sort(() => Math.random() - 0.5), []);
            const [placed, setPlaced] = useState({});

            const drop = (cat) => {
                if (!active || disabled) return;
                if (categories.find(c => c.items.includes(active))?.name === cat) {
                    const next = { ...placed, [active]: cat };
                    setPlaced(next); setActive(null);
                    if (Object.keys(next).length === allItems.length) onAnswer(true);
                } else setActive(null);
            };

            return (
                <div className="space-y-6">
                    <div className="flex flex-wrap gap-2 p-4 bg-stone-50 rounded-xl border border-stone-200">
                        {allItems.map((it, i) => !placed[it] && <button key={i} onClick={() => setActive(it)} className={`px-4 py-2 text-sm border-2 rounded-lg transition-all ${active === it ? 'border-amber-500 bg-amber-50' : 'bg-white border-stone-200'}`}>{it}</button>)}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        {categories.map((c, i) => <button key={i} onClick={() => drop(c.name)} className="p-8 border-2 border-dashed border-stone-300 rounded-xl hover:border-amber-400 hover:bg-amber-50 text-xs font-bold text-stone-400 uppercase tracking-widest">{c.name} ({Object.values(placed).filter(v => v === c.name).length})</button>)}
                    </div>
                </div>
            );
        };

        const ExerciseRenderer = ({ exercise, onAnswer, disabled }) => {
            switch (exercise.type) {
                case 'MULTIPLE_CHOICE':
                case 'GAP_FILL':
                    return (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {exercise.options?.map((opt, i) => (
                                <button key={i} onClick={() => onAnswer(opt)} disabled={disabled} className={`p-5 text-left border-2 rounded-xl transition-all font-medium ${disabled ? 'opacity-50 cursor-default' : 'border-stone-200 hover:border-amber-500 hover:bg-amber-50'}`}>{opt}</button>
                            ))}
                        </div>
                    );
                case 'TRUE_FALSE':
                    return (
                        <div className="flex gap-4">
                            <button onClick={() => onAnswer(true)} disabled={disabled} className={`flex-1 p-6 border-2 rounded-xl transition-all font-bold text-lg ${disabled ? 'opacity-50 cursor-default' : 'border-stone-200 hover:border-green-500 hover:bg-green-50'}`}>ჭეშმარიტია</button>
                            <button onClick={() => onAnswer(false)} disabled={disabled} className={`flex-1 p-6 border-2 rounded-xl transition-all font-bold text-lg ${disabled ? 'opacity-50 cursor-default' : 'border-stone-200 hover:border-red-500 hover:bg-red-50'}`}>მცდარია</button>
                        </div>
                    );
                case 'ORDERING':
                    return <OrderingWidget items={exercise.orderingItems} onAnswer={onAnswer} disabled={disabled} />;
                case 'MATCHING':
                    return <MatchingWidget pairs={exercise.matchingPairs} onAnswer={onAnswer} disabled={disabled} />;
                case 'CATEGORIZATION':
                    return <CategorizationWidget categories={exercise.categories} onAnswer={onAnswer} disabled={disabled} />;
                default: return null;
            }
        };

        // --- Main App ---

        const App = () => {
            const [started, setStarted] = useState(false);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [finished, setFinished] = useState(false);
            const [exercises, setExercises] = useState([]);
            const [feedback, setFeedback] = useState(null);
            const [wrongTopics, setWrongTopics] = useState([]);

            useEffect(() => {
                setExercises([...EXERCISES].sort(() => Math.random() - 0.5));
            }, []);

            const currentExercise = exercises[currentIdx];

            const handleAnswer = (answer) => {
                if (feedback) return;
                let isCorrect = false;
                if (currentExercise.type === 'MULTIPLE_CHOICE' || currentExercise.type === 'GAP_FILL' || currentExercise.type === 'TRUE_FALSE') {
                    isCorrect = answer === currentExercise.correctAnswer;
                } else if (currentExercise.type === 'ORDERING') {
                    isCorrect = JSON.stringify(answer) === JSON.stringify(currentExercise.correctAnswer);
                } else {
                    isCorrect = true; 
                }

                if (isCorrect) setScore(s => s + 1);
                else setWrongTopics(prev => [...new Set([...prev, currentExercise.difficulty])]);
                setFeedback({ isCorrect, explanation: currentExercise.explanation });
            };

            const nextQuestion = () => {
                setFeedback(null);
                if (currentIdx < exercises.length - 1) setCurrentIdx(i => i + 1);
                else setFinished(true);
            };

            const restart = () => {
                setStarted(false); setFinished(false); setCurrentIdx(0); setScore(0); setFeedback(null); setWrongTopics([]);
                setExercises([...EXERCISES].sort(() => Math.random() - 0.5));
            };

            if (!started) return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-stone-100 bg-[url('https://www.transparenttextures.com/patterns/paper.png')]">
                    <div className="bg-white/95 p-12 md:p-20 rounded-3xl shadow-2xl max-w-2xl text-center border-t-8 border-amber-800 animate-fade-in">
                        <h1 className="georgian-classic text-5xl md:text-7xl font-bold text-stone-900 mb-8">ვეფხისტყაოსანი</h1>
                        <p className="text-xl text-stone-600 mb-12 leading-relaxed">ინტერაქტიული სასწავლო ტესტი<br/><span className="text-amber-800 font-bold">სტროფები 1070-1221</span></p>
                        <button onClick={() => setStarted(true)} className="px-16 py-6 bg-amber-900 text-white rounded-2xl font-bold text-xl hover:bg-amber-800 transition-all shadow-xl active:scale-95">დაწყება</button>
                    </div>
                </div>
            );

            if (finished) return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-stone-50">
                    <div className="bg-white p-12 md:p-16 rounded-3xl shadow-2xl max-w-xl w-full text-center animate-fade-in">
                        <div className="text-7xl font-bold text-amber-600 mb-4">{Math.round((score/exercises.length)*100)}%</div>
                        <h2 className="text-3xl font-bold text-stone-800 mb-2">ტესტი დასრულდა</h2>
                        <p className="text-stone-500 mb-10">სწორი პასუხები: {score} / {exercises.length}</p>
                        {wrongTopics.length > 0 && <div className="text-left bg-stone-50 p-6 rounded-xl mb-10"><h4 className="text-xs font-bold text-stone-400 uppercase mb-3">ხარვეზები:</h4><div className="flex flex-wrap gap-2">{wrongTopics.map((t, i) => <span key={i} className="px-3 py-1 bg-white border border-stone-200 text-stone-600 rounded-lg text-sm">{t}</span>)}</div></div>}
                        <button onClick={restart} className="w-full py-5 bg-stone-900 text-white rounded-2xl font-bold text-xl hover:bg-stone-800 transition-all">თავიდან დაწყება</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col items-center p-4 md:p-8 max-w-4xl mx-auto animate-fade-in">
                    <div className="w-full mb-8 sticky top-0 bg-stone-50/90 backdrop-blur py-4 z-10 border-b border-stone-100">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-xs font-bold text-stone-400 uppercase tracking-widest">ვეფხისტყაოსანი: 1070-1221</span>
                            <span className="text-sm font-bold text-amber-700">{currentIdx + 1} / {exercises.length}</span>
                        </div>
                        <div className="w-full h-2 bg-stone-200 rounded-full overflow-hidden">
                            <div className="h-full bg-amber-600 transition-all duration-500 ease-out" style={{ width: `${((currentIdx + 1) / exercises.length) * 100}%` }} />
                        </div>
                    </div>

                    <div className="w-full bg-white rounded-2xl shadow-xl border border-stone-100 p-6 md:p-10 transition-all">
                        <div className="flex items-center gap-3 mb-6">
                            <span className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase ${
                                currentExercise.difficulty === 'მარტივი' ? 'bg-green-100 text-green-700' :
                                currentExercise.difficulty === 'საშუალო' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'
                            }`}>{currentExercise.difficulty}</span>
                        </div>

                        {currentExercise.stanza && (
                            <div className="bg-stone-50 border-l-4 border-amber-400 p-6 mb-8 italic text-stone-700 leading-relaxed rounded-r-xl shadow-inner">
                                <p className="georgian-classic text-lg md:text-xl whitespace-pre-wrap">{currentExercise.stanza}</p>
                            </div>
                        )}

                        <h2 className="text-xl md:text-2xl font-bold text-stone-800 mb-8 leading-snug">{currentExercise.question}</h2>
                        <div className="space-y-4">
                            <ExerciseRenderer exercise={currentExercise} onAnswer={handleAnswer} disabled={!!feedback} />
                        </div>
                    </div>

                    {feedback && (
                        <div className={`mt-8 w-full p-6 rounded-xl border-2 animate-fade-in ${feedback.isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                            <div className="flex items-start gap-4">
                                <div className={`p-2 rounded-full ${feedback.isCorrect ? 'bg-green-500' : 'bg-red-500'}`}>
                                    <svg className="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        {feedback.isCorrect ? <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /> : <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M6 18L18 6M6 6l12 12" />}
                                    </svg>
                                </div>
                                <div className="flex-1">
                                    <h3 className={`font-bold text-lg ${feedback.isCorrect ? 'text-green-800' : 'text-red-800'}`}>{feedback.isCorrect ? 'სწორია!' : 'არასწორია'}</h3>
                                    <p className="text-stone-600 mt-1 leading-relaxed">{feedback.explanation}</p>
                                    <button onClick={nextQuestion} className="mt-6 px-8 py-3 bg-stone-800 text-white rounded-lg font-bold hover:bg-stone-700 transition-colors shadow-md">შემდეგი</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
